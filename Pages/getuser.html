<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>T√¨m ki·∫øm nh√¢n vi√™n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        #searchInput {
            width: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #results {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #results div {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #results div:hover {
            background-color: #f0f0f0;
        }
        
        #results div:last-child {
            border-bottom: none;
        }
        
        .user-info {
            font-weight: bold;
        }
        
        .user-email {
            color: #666;
            font-size: 12px;
        }
        
        .user-department {
            color: #007acc;
            font-size: 11px;
            font-style: italic;
        }
        
        .selected {
            background-color: #d0f0d0 !important;
        }
        
        #okButton {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #okButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #selectedOutput {
            margin-top: 10px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .search-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h2>T√¨m ki·∫øm nh√¢n vi√™n theo t√™n/email/ph√≤ng ban</h2>
    <input type="text" id="searchInput" placeholder="G√µ √≠t nh·∫•t 3 k√Ω t·ª±..." />
    <div class="search-hint">C√≥ th·ªÉ t√¨m theo: t√™n, email, m√£ ph√≤ng ban (v√≠ d·ª•: P.MKT, TP.CNTT)</div>
    <div id="results"></div>
    <button id="okButton" disabled>OK</button>
    <p id="selectedOutput"></p>

    <script>
        const accessToken = localStorage.getItem("access_token");
        let selectedEmail = null;
        let allUsers = []; // Cache ƒë·ªÉ l∆∞u t·∫•t c·∫£ users

        const searchInput = document.getElementById("searchInput");
        const resultsDiv = document.getElementById("results");
        const okButton = document.getElementById("okButton");
        const output = document.getElementById("selectedOutput");

        // H√†m extract m√£ ph√≤ng ban t·ª´ displayName
        function extractDepartment(displayName) {
            // T√¨m t·∫•t c·∫£ n·ªôi dung trong d·∫•u ngo·∫∑c ƒë∆°n
            const matches = displayName.match(/\(([^)]+)\)/g);
            if (matches) {
                // L·∫•y match cu·ªëi c√πng v√† lo·∫°i b·ªè d·∫•u ngo·∫∑c
                const lastMatch = matches[matches.length - 1];
                return lastMatch.replace(/[()]/g, '');
            }
            return "";
        }

        // H√†m t√¨m ki·∫øm local trong cache
        function searchInCache(query) {
            const normalizedQuery = query.toLowerCase().trim();
            console.log(`üîé T√¨m ki·∫øm v·ªõi query: "${normalizedQuery}"`);
            
            const results = allUsers.filter(user => {
                const displayName = (user.displayName || "").toLowerCase();
                const email = (user.mail || user.userPrincipalName || "").toLowerCase();
                const department = extractDepartment(user.displayName || "").toLowerCase();
                
                const matchName = displayName.includes(normalizedQuery);
                const matchEmail = email.includes(normalizedQuery);
                const matchDept = department.includes(normalizedQuery);
                
                // Log chi ti·∫øt cho query P.CNTT
                if (normalizedQuery === "p.cntt" && (matchName || matchEmail || matchDept)) {
                    console.log(`‚úÖ T√¨m th·∫•y: "${user.displayName}"`);
                    console.log(`   - Display: "${displayName}"`);
                    console.log(`   - Department: "${department}"`);
                    console.log(`   - Match: name=${matchName}, email=${matchEmail}, dept=${matchDept}`);
                }
                
                return matchName || matchEmail || matchDept;
            });
            
            console.log(`üìä T·ªïng k·∫øt qu·∫£: ${results.length}`);
            return results;
        }

        // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£
        function displayResults(users) {
            resultsDiv.innerHTML = "";
            
            if (users.length > 0) {
                users.forEach(user => {
                    const div = document.createElement("div");
                    const department = extractDepartment(user.displayName || "");
                    
                    div.innerHTML = `
                        <div class="user-info">${user.displayName}</div>
                        <div class="user-email">${user.mail || user.userPrincipalName}</div>
                        ${department ? `<div class="user-department">Ph√≤ng: ${department}</div>` : ''}
                    `;
                    
                    div.onclick = () => {
                        selectedEmail = user.mail || user.userPrincipalName;
                        okButton.disabled = false;
                        
                        // Remove selection t·ª´ t·∫•t c·∫£ items
                        Array.from(resultsDiv.children).forEach(c => c.classList.remove('selected'));
                        div.classList.add('selected');
                    };
                    
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.innerHTML = "<p style='padding: 8px; color: #666;'>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>";
            }
        }

        // Load t·∫•t c·∫£ users v√†o cache (ch·ªâ ch·∫°y 1 l·∫ßn)
        async function loadAllUsers() {
            try {
                let allFetchedUsers = [];
                let nextLink = "https://graph.microsoft.com/v1.0/users?$select=displayName,mail,userPrincipalName&$top=999";
                
                while (nextLink) {
                    const response = await fetch(nextLink, {
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.value) {
                        allFetchedUsers = allFetchedUsers.concat(data.value);
                    }
                    
                    nextLink = data['@odata.nextLink'] || null;
                }
                
                allUsers = allFetchedUsers;
                console.log(`ƒê√£ load ${allUsers.length} users v√†o cache`);
            } catch (error) {
                console.error("L·ªói khi load users:", error);
            }
        }

        // X·ª≠ l√Ω s·ª± ki·ªán khi g√µ t√¨m ki·∫øm
        let searchTimeout;
        searchInput.addEventListener("input", () => {
            const query = searchInput.value.trim();
            
            // Clear timeout c≈©
            clearTimeout(searchTimeout);
            
            if (query.length < 3) {
                resultsDiv.innerHTML = "";
                return;
            }

            // Debounce search
            searchTimeout = setTimeout(() => {
                console.log(`üîç T√¨m ki·∫øm: "${query}"`);
                console.log(`üìä S·ªë users trong cache: ${allUsers.length}`);
                
                if (allUsers.length > 0) {
                    // T√¨m ki·∫øm trong cache
                    const results = searchInCache(query);
                    console.log(`üìù K·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c: ${results.length}`);
                    results.forEach((user, index) => {
                        if (index < 3) { // Log 3 k·∫øt qu·∫£ ƒë·∫ßu
                            console.log(`  ${index + 1}. ${user.displayName} - ${user.mail || user.userPrincipalName}`);
                        }
                    });
                    displayResults(results);
                } else {
                    console.log("‚ö†Ô∏è Cache ch∆∞a s·∫µn s√†ng, d√πng API fallback");
                    // Fallback v·ªÅ API g·ªëc n·∫øu cache ch∆∞a load
                    searchViaAPI(query);
                }
            }, 300);
        });

        // Fallback search via API - s·ª≠ d·ª•ng contains thay v√¨ startswith
        function searchViaAPI(query) {
            // Graph API kh√¥ng c√≥ contains tr·ª±c ti·∫øp, n√™n ta d√πng $search
            // Ho·∫∑c load nhi·ªÅu d·ªØ li·ªáu h∆°n v√† filter ph√≠a client
            fetch(`https://graph.microsoft.com/v1.0/users?$select=displayName,mail,userPrincipalName&$top=999`, {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.value) {
                    // Filter ph√≠a client
                    const filtered = data.value.filter(user => {
                        const displayName = (user.displayName || "").toLowerCase();
                        const email = (user.mail || user.userPrincipalName || "").toLowerCase();
                        const normalizedQuery = query.toLowerCase().trim();
                        
                        return displayName.includes(normalizedQuery) || email.includes(normalizedQuery);
                    });
                    
                    displayResults(filtered.slice(0, 20)); // Ch·ªâ hi·ªÉn th·ªã 20 k·∫øt qu·∫£ ƒë·∫ßu
                } else {
                    resultsDiv.innerHTML = "<p style='padding: 8px; color: #666;'>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>";
                }
            })
            .catch(err => {
                console.error("L·ªói khi t√¨m ki·∫øm user:", err);
                resultsDiv.innerHTML = "<p style='padding: 8px; color: #f44336;'>L·ªói khi g·ªçi API</p>";
            });
        }

        // X·ª≠ l√Ω khi ·∫•n OK
        okButton.addEventListener("click", () => {
            if (selectedEmail) {
                output.textContent = `Email ƒë√£ ch·ªçn: ${selectedEmail}`;
            }
        });

        // Load users v√†o cache khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', () => {
            loadAllUsers();
        });
    </script>

    <script>
        // Ki·ªÉm tra token, n·∫øu kh√¥ng c√≥ th√¨ quay v·ªÅ trang login
        (function () {
            const token = localStorage.getItem("access_token");
            if (!token) {
                window.location.href = "../index.html";
            }
        })();

        // ƒêƒÉng xu·∫•t v√† lu√¥n y√™u c·∫ßu ch·ªçn t√†i kho·∫£n khi ƒëƒÉng nh·∫≠p l·∫°i
        function logoutAndChooseAccount() {
            localStorage.removeItem("access_token");
            window.location.href = "../index.html?prompt=select_account";
        }
    </script>
</body>
</html>